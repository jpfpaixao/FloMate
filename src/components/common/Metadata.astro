---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: I18N?.language || 'en',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);
---

<AstroSeo {...{ ...seoProps, openGraph: await adaptOpenGraphImages(seoProps?.openGraph, Astro.site) }} />

<!-- Organization Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "FlowMate",
  "url": "https://flomate.co",
  "description": "Digital consulting for operational excellence",
  "image": "https://flomate.co/assets/images/default.png",
  "sameAs": [
    "https://linkedin.com"
  ],
  "contactPoint": {
    "@type": "ContactPoint",
    "email": "info@flomate.co",
    "contactType": "Customer Service"
  }
}
</script>

<!-- Service Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Service",
  "name": "Operational Consulting",
  "description": "Digital consulting for organizational efficiency and operational excellence",
  "provider": {
    "@type": "Organization",
    "name": "FlowMate"
  },
  "areaServed": "Worldwide",
  "serviceType": ["Diagnosis", "Process Redesign", "Implementation", "Continuous Improvement"]
}
</script>

<!-- Breadcrumb Schema -->
<script type="application/ld+json" define:vars={{pathname: Astro.url.pathname}}>
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://flomate.co"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": pathname === '/services' ? "Our Services" : pathname === '/about' ? "About Us" : pathname === '/contact' ? "Contact Us" : pathname === '/privacy' ? "Privacy Policy" : pathname === '/terms' ? "Terms & Conditions" : "Page",
      "item": pathname === '/' ? "https://flomate.co" : `https://flomate.co${pathname}`
    }
  ]
}
</script>
